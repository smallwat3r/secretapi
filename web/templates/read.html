{{define "content"}}
<div id="read">
    <form id="passcode-form">
        <input id="passcode" placeholder="Enter passcode" required>
        <button type="submit">Read Secret</button>
    </form>
    <div id="result"></div>
</div>
{{end}}

{{define "scripts"}}
<script>
    const form = document.getElementById('passcode-form');
    const resultDiv = document.getElementById('result');
    const id = window.location.pathname.split('/')[2];

    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const passcode = document.getElementById('passcode').value;
        resultDiv.textContent = 'Loading...';
        resultDiv.className = '';

        try {
            const response = await fetch(`/read/${id}`, {
                method: 'POST',
                headers: {
                    'X-Passcode': passcode
                }
            });

            if (response.ok) {
                const data = await response.json();
                resultDiv.innerHTML = '';

                const secretContainer = document.createElement('div');
                secretContainer.className = 'copyable';
                secretContainer.textContent = data.secret;
                resultDiv.appendChild(secretContainer);
                
                form.style.display = 'none';

                const copyButton = document.createElement('button');
                copyButton.textContent = 'Copy to Clipboard';
                copyButton.style.marginTop = '16px';
                copyButton.style.width = '100%';
                copyButton.style.padding = '12px 16px';
                copyButton.style.fontSize = '16px';
                copyButton.style.color = '#fff';
                copyButton.style.backgroundColor = '#000';
                copyButton.style.border = 'none';
                copyButton.style.borderRadius = '0';
                copyButton.style.cursor = 'pointer';
                copyButton.style.webkitAppearance = 'none';
                resultDiv.appendChild(copyButton);

                const newSecretButton = document.createElement('button');
                newSecretButton.style.marginTop = '8px';
                newSecretButton.style.width = '100%';
                newSecretButton.style.padding = '12px 16px';
                newSecretButton.style.fontSize = '16px';
                newSecretButton.style.color = '#000';
                newSecretButton.style.backgroundColor = '#fff';
                newSecretButton.style.border = '1px solid #000';
                newSecretButton.style.borderRadius = '0';
                newSecretButton.style.cursor = 'pointer';
                newSecretButton.style.webkitAppearance = 'none';
                newSecretButton.style.position = 'relative';
                newSecretButton.style.overflow = 'hidden';

                const buttonText = document.createElement('span');
                buttonText.textContent = 'Create New Secret';
                buttonText.style.position = 'relative';
                buttonText.style.zIndex = '1';

                const progressBar = document.createElement('div');
                progressBar.style.position = 'absolute';
                progressBar.style.top = '0';
                progressBar.style.left = '0';
                progressBar.style.height = '100%';
                progressBar.style.width = '0%';
                progressBar.style.backgroundColor = '#eee';
                
                newSecretButton.appendChild(progressBar);
                newSecretButton.appendChild(buttonText);
                resultDiv.appendChild(newSecretButton);

                let pressTimer;

                const cancelHold = () => {
                    buttonText.textContent = 'Create New Secret';
                    clearTimeout(pressTimer);
                    progressBar.style.transition = 'width 0.2s ease-out';
                    progressBar.style.width = '0%';
                };

                newSecretButton.addEventListener('mousedown', () => {
                    buttonText.textContent = 'Hold...';
                    
                    progressBar.style.transition = 'width 1s linear';
                    progressBar.style.width = '100%';

                    pressTimer = window.setTimeout(() => {
                        window.location.href = '/';
                    }, 1000);
                });

                newSecretButton.addEventListener('mouseup', cancelHold);
                newSecretButton.addEventListener('mouseleave', cancelHold);

                copyButton.addEventListener('click', () => {
                    navigator.clipboard.writeText(data.secret).then(() => {
                        copyButton.textContent = 'Copied!';
                        setTimeout(() => {
                            copyButton.textContent = 'Copy to Clipboard';
                        }, 2000);
                    }).catch(err => {
                        console.error('Failed to copy text: ', err);
                    });
                });
            } else {
                const errorText = await response.text();
                try {
                    const errorData = JSON.parse(errorText);
                    resultDiv.textContent = errorData.error || 'An unknown error occurred.';
                } catch (e) {
                    resultDiv.textContent = errorText;
                }
                resultDiv.classList.add('error');
            }
        } catch (error) {
            resultDiv.textContent = `An unexpected error occurred. Please try again.`;
            resultDiv.classList.add('error');
        }
    });

    window.addEventListener('pageshow', function(event) {
        if (event.persisted) {
            document.getElementById('passcode').value = '';
            resultDiv.textContent = '';
            resultDiv.className = '';
            form.style.display = 'block';
        }
    });
</script>
{{end}}
